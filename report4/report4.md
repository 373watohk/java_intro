# 課題レポート4: リファクタリングを通してユニットテストとバージョン管理に慣れよう

- 前期からの変更点
  - 課題説明は「課題概要」のみで十分です。
  - 今回のレポート3についても「最大3ページ」に収めるようにして下さい。
    - ソースファイルも提出してもらうので、レポートに全コードコピペ掲載する必要はありません。特に工夫した点のみを掲載した上で解説・考察しよう。

- ＜目次＞
- <a href="#abst">課題概要</a>
- <a href="#details">詳細仕様</a>
  - <a href="#details_step0">ステップ0: コードの準備。</a>
  - <a href="#details_step1">ステップ1: 死亡した後で攻撃できてしまう件をどうにかしたい。</a>
  - <a href="#details_step2">ステップ2: EnemyクラスとHeroクラスの重複をどうにかしたい。</a>
  - <a href="#details_step3">ステップ3: カプセル化しよう。</a>
- <a href="#output_example">実行例</a>
- <a href="#report">取り組み方</a>
- <a href="#submit">提出方法</a>

<hr>
## <a name="abst">課題概要</a>
7回目の授業で利用したコード例[ExampleUnitTest](https://github.com/naltoma/ExampleUnitTest)は、コードの書き方があまりヨロシクない。ユニットテストとバージョン管理システムを使いながら、一歩ずつリファクタリングしてみよう。

<hr>
## <a name="details">詳細仕様</a>
### <a name="details_step0">ステップ0: コードの準備。</a>
- IntelliJで新規プロジェクトを作成せよ。プロジェクト名は「Report4」とする。
- [サンプルコードの準備](https://github.com/naltoma/java_intro/blob/master/IntelliJ%2BJunit4.md#pre)を参考に、Hero.java, Enemy.java, Main.java, EnemyTest.java の4つを適切に配置し、リソース設定せよ。
  - pacakge名は自身のものに修正すること。
- Main.javaとEnemyTest.javaを実行し、動作することを確認できたら commit & pushせよ。
  - push先は、GitHubは学科Gitlabサーバのいずれかとする。
  - これで何か問題が起きても、この時点のコードに戻ることができるようになる。
  - EnemyTest.javaのテストは、この時点では失敗して良い。テストが機能していることを確認しよう。
- レポート報告事項
  - ステップ0に関しては、pushしたリポジトリURL（作業用URL）を報告するだけで良い。

<hr>

### <a name="details_step1">ステップ1: 死亡した後で攻撃できてしまう件をどうにかしたい。</a>
- EnemyTestのattack()では、enemy.deadがtrueの時、すなわちenemyが死亡している時に攻撃できてしまうことを検証している。
  - Enemy.javaのattack()だけを修正し、「enemyが死亡時に攻撃できない」ようにせよ。他クラスやメソッドは変更しないこと。
    - ここで「攻撃できない」とは、相手のHPが減らないこととする。
  - 死亡時に攻撃できないようになれば、EnemyTest.attack()のテストは成功するはずである。成功したら、commit & push せよ。
- レポート報告事項
  - EnemyTest.attack()の差分コードを以下の手順で掲載し、どのように修正したのか解説せよ。
    - 差分コードの出力手順
      - ターミナルでプロジェクトを保存しているディレクトリに移動する。（デフォルトなら ~/IdeaProjects/Report4/ 以下にあるはず）
      - ``git log -p -1`` を実行し、直近1つのコミットでの変更点を出力させる。この実行結果全体をレポートに含めよう。（このコマンドの意味は[前期資料](https://ie.u-ryukyu.ac.jp/~tnal/2016/prog1/Git.html#5)で確認しよう。）
  - 想定: 数行の追加で終わるはず。

<hr>

### <a name="details_step2">ステップ2: EnemyクラスとHeroクラスの重複をどうにかしたい。</a>
- EnemyクラスとHeroクラスを眺めると、殆どが同一コードであることに気づくはずだ。先程 Enemy.attack() を修正したが、同じ修正コードを Hero.java にも追加記述するのはあまりヨロシクない。（DRY原則）
  - いろんな対応方法が考えられるが、ここでは以下のように修正してみよう。
    - 両方に共通するLivingThingクラスを新規作成しよう。
      - フィールド変数として下記4項目を持つものとする。
        - String name;
        - int hitPoint;
        - int attack;
        - boolean dead;
      - コンストラクタとしてname, hitPoint, attackの3つを引数に取り、Enemy,Heroと同等の処理を実行しよう。（dead変数の初期化も忘れないようにしよう）
      - 下記メソッドを作成。
        - public boolean isDead()
        - public String getName()
        - public void attack(LivingThing opponent)
          - Enemyクラスではheroを攻撃、Heroクラスではenemyを攻撃するようにしていたが、共通クラスとして作成している本クラスを対象に攻撃するように変更しよう。
        - public void wounded(int damage)
    - LivingThingを継承して、EnemyクラスとHeroクラスを設計し直そう。
      - EnemyクラスとHeroクラスとも、現時点では異なる実装はないため、フィールド変数とメソッドは不要である。コンストラクタだけ用意してあげよう。（superで親クラスのコンストラクタを呼び出そう）
- 確認項目
  - LivingThingクラス、それらを継承して作成し直したEnemyクラスとHeroクラスを修正し終えたら、Main.javaを実行してみよう。こちらは特に編集不要で、元の処理を再現できているはずである。また、attack()を親クラスで修正済みのため、enemy死亡後に攻撃してしまうことは無くなったはずである。
    - 同様に、今回は確認していないが、元のHeroクラスでも「死亡後に攻撃できる」状態だった。しかし修正後は、親クラスで修正済みのため、修正後のHeroクラスは死亡後攻撃はできなくなっているはずだ。
  - EnemyTestクラスのテストを実行してみよう。こちらも修正済みのため、グリーン表示になるはずである。
  - 上記2点を確認できたら、commit & push しよう。
- レポート報告事項
  - コード掲載は不要である。今回のコード修正を通して、気づいたことを報告せよ。

<hr>

### <a name="details_step3">ステップ3: カプセル化しよう。</a>
- LivingThingクラスのフィールド変数（String name, int hitPoint, int attack, boolean dead）は、全てアクセス修飾子なしになっている。勝手に他のクラスから修正されると困るため、これらをカプセル化しよう。
  - 上記4変数を private にし、用意されてないgetter/setterも用意しよう。
  - この隠蔽化に伴い、直接フィールド変数へアクセスしている箇所でエラーが起きるはずだ。
    - 具体的には EnemyTest.java。
  - エラーが起きた箇所を、メソッドを利用することで修正しよう。
  - MainクラスとEnemyTestクラスが正常動作することを確認できたら、commit & push しよう。
- レポート報告事項
  - EnemyTest.attack() のコードを掲載し、どう修正したのか説明せよ。


<hr>
## <a name="output_example">実行例</a>
- 修正前: ExampleUnitTest での実行例。
  - 修正前は、スライムが倒れた後も攻撃している。

```
勇者のHPは10。攻撃力は5です。
スライムのHPは6。攻撃力は3です。
勇者 vs. スライム
1ターン目開始！
勇者の攻撃！スライムに4のダメージを与えた！！
スライムの攻撃！勇者に0のダメージを与えた！！
2ターン目開始！
勇者の攻撃！スライムに3のダメージを与えた！！
モンスタースライムは倒れた。
スライムの攻撃！勇者に2のダメージを与えた！！
戦闘終了
```

- レポート4指定通りに修正後の実行例。
  - スライムが倒れた後に攻撃してない点に注意。

```
勇者のHPは10。攻撃力は5です。
スライムのHPは6。攻撃力は3です。
勇者 vs. スライム
1ターン目開始！
勇者の攻撃！スライムに3のダメージを与えた！！
スライムの攻撃！勇者に2のダメージを与えた！！
2ターン目開始！
勇者の攻撃！スライムに1のダメージを与えた！！
スライムの攻撃！勇者に0のダメージを与えた！！
3ターン目開始！
勇者の攻撃！スライムに2のダメージを与えた！！
スライムの攻撃！勇者に2のダメージを与えた！！
4ターン目開始！
勇者の攻撃！スライムに0のダメージを与えた！！
スライムの攻撃！勇者に1のダメージを与えた！！
5ターン目開始！
勇者の攻撃！スライムに0のダメージを与えた！！
スライムの攻撃！勇者に0のダメージを与えた！！
6ターン目開始！
勇者の攻撃！スライムに0のダメージを与えた！！
スライムの攻撃！勇者に0のダメージを与えた！！
7ターン目開始！
勇者の攻撃！スライムに3のダメージを与えた！！
モンスタースライムは倒れた。
戦闘終了
```


<hr>

## <a name="report">取り組み方</a>
- ペアや友人らと話し合って取り組んで構わないが、コード解説を加えるなど「自分自身の報告書」となるように取り組むこと。試して分かったこと、自身で解決できなかった部分等についてどう取り組んだか、といった過程がわかるように示すこと。（考えを図表や文章を駆使して表現して報告する練習です）
- レポート作成は好きなツール（ソフトウェア）を使って構わない。ただし下記を含めること。
  - タイトル
    - 今回は「**プログラミング2、レポート課題4: 「リファクタリングを通してユニットテストとバージョン管理に慣れよう」**」。
  - 提出日: yyyy-mm-dd
  - 報告者: 学籍番号、氏名
    - 複数人で相談しながらやった場合、相談者らを「**協力者: 学籍番号、氏名**」として示そう。
  - 課題説明（概要のみでOK）
  - 結果と考察
    - **課題への取り組みを通し、課題の意義、課題から分かったこと、今後の展望などを述べる。失敗やつまづきがあれば、それらについての失敗分析を含めること。**
    - 参考リンク: [実験レポートの書き方](http://www.report.gusoku.net/jikken/jikkenreport.html)
  - その他
    - 通常は感想等をレポートには含めませんが、練習なので課題に取り組みながら何か感じたこと、悩んでいること等、書きたいことがあれば自由に書いてください。（なければ省略OK）

<hr>

## <a name="submit">提出方法</a>
- 提出物は「レポート」、「作成したソースファイル」の2点である。
- レポートは電子ファイルで提出するものとする。
- 提出先:
  - 「<a href="https://drive.google.com/a/ie.u-ryukyu.ac.jp/folderview?id=0B8oAeomiuJo-OFUxYjNyT083OGM&usp=sharing">Google ドキュメント</a>」のreport4。
- 締切: 調整中。
